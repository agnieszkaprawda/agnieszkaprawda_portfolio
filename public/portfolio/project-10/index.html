<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8" />
  <title>Estimation Engine for London House Prices with Stacked Final Model using Tree Models, LASSO, Random Forest &amp; GBM</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  
  <meta name="author" content="StaticMania">
  
  <meta name="generator" content="Hugo 0.74.3" />

  <!-- Bootstrap -->
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" />
  <!-- font-awesome -->
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" />
  <!-- Main Stylesheets -->
  
  <link href="/scss/style.min.css" rel="stylesheet" />

  
  <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
  <link rel="icon" href="/images/favicon.ico" type="image/x-icon" />
</head><body><nav class="navbar navbar-expand-lg site-navigation">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img src="/images/logo.png" alt="logo" />
    </a>
    <button
      class="navbar-toggler collapsed"
      type="button"
      data-toggle="collapse"
      data-target="#sitenavbar"
    >
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>

    <div class="collapse navbar-collapse" id="sitenavbar">
      <ul class="navbar-nav ml-auto main-nav">
         
         
         
          
          <li class="nav-item">
            <a class="nav-link" href="/"
              >Home</a
            >
          </li>
           
         
          
          <li class="nav-item">
            <a class="nav-link" href="/portfolio"
              >Portfolio</a
            >
          </li>
           
         
          
          <li class="nav-item">
            <a class="nav-link" href="/blog"
              >Other Projects</a
            >
          </li>
           
         
          
          <li class="nav-item">
            <a
              class="nav-link btn btn-sm btn-primary btn-sm-rounded"
              href="/contact"
            >
              <span class="btn-area">
                <span data-text="Get in touch">
                  Get in touch
                </span>
              </span>
            </a>
          </li>
           
        
      </ul>
    </div>
  </div>
</nav>
<main>

<section class="site-project-single-section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="site-project-single">
          <h1>
            Estimation Engine for London House Prices with Stacked Final Model using Tree Models, LASSO, Random Forest &amp; GBM
          </h1>
          <div class="site-project-single-description">
            


<style type="text/css">

.pink { background-color:#fae6e6 ; 
    border-radius: 5px; 
  padding: 20px; color: #000000;}

.blue { background-color:#DFF5F6 ; 
    border-radius: 5px; 
  padding: 20px; color: #000000;}
    
.whitep { background-color:#fffafa ;
    border: 3px gray;
    border-radius: 5px; 
  padding: 20px; color: #000000;}
    
.whiteb { background-color:#f7ffff ;
    border: 3px gray;
    border-radius: 5px; 
  padding: 20px; color: #000000;}

    
</style>
<p>The purpose of this project is to build an estimation engine to guide investment decisions in London house market. I will first build machine learning algorithms (and tune them) to estimate the house prices given variety of information about each property. Then, using my algorithm, I will choose 200 houses to invest in out of about 2000 houses on the market at the moment.</p>
<p><b>Objectives</b></p>
<ol type="i">
<li>
Using different data mining algorithms for prediction.
</li>
<li>
Dealing with large data sets
</li>
<li>
Tuning data mining algorithms
</li>
<li>
Interpreting data mining algorithms and deducing importance of variables
</li>
<li>
Using results of data mining algorithms to make business decisions
</li>
</ol>
<div id="load-data" class="section level3">
<h3>Load data</h3>
<p>There are two sets of data, i) training data that has the actual prices ii) out of sample data that has the asking prices. I will now load both data sets.</p>
<p>I will make sure to understand what information each column contains. Note that not all information provided might be useful in predicting house prices, but do not make any assumptions before you decide what information you use in your prediction algorithms.</p>
<pre class="r pink"><code>#reading in the data
london_house_prices_2019_training&lt;-read_csv(&quot;~/Documents/LBS/Data Science/Session 10/workshop/training_data_assignment_with_prices.csv&quot;)
london_house_prices_2019_out_of_sample&lt;-read_csv(&quot;~/Documents/LBS/Data Science/Session 10/workshop/test_data_assignment.csv&quot;)

#fixing the dates
london_house_prices_2019_out_of_sample&lt;- london_house_prices_2019_out_of_sample %&gt;% 
  mutate(date=as.Date(date))

london_house_prices_2019_training&lt;- london_house_prices_2019_training %&gt;% 
  mutate(date=as.Date(date))

#changing characters to factors
london_house_prices_2019_out_of_sample &lt;- london_house_prices_2019_out_of_sample %&gt;% mutate_if(is.character, as.factor)

london_house_prices_2019_training &lt;- london_house_prices_2019_training %&gt;% mutate_if(is.character, as.factor)


#making sure out of sample data and training data have the same number of factors
a&lt;-union(levels(london_house_prices_2019_training$postcode_short),levels(london_house_prices_2019_out_of_sample$postcode_short))
london_house_prices_2019_training$postcode_short&lt;- factor(london_house_prices_2019_training$postcode_short,levels=a)
london_house_prices_2019_out_of_sample$postcode_short&lt;-factor(london_house_prices_2019_out_of_sample$postcode_short, levels=a)

b&lt;-union(levels(london_house_prices_2019_training$water_company),levels(london_house_prices_2019_out_of_sample$water_company))
london_house_prices_2019_training$water_company&lt;- factor(london_house_prices_2019_training$water_company,levels=b)
london_house_prices_2019_out_of_sample$water_company&lt;-factor(london_house_prices_2019_out_of_sample$water_company, levels=b)

c&lt;-union(levels(london_house_prices_2019_training$nearest_station),levels(london_house_prices_2019_out_of_sample$nearest_station))
london_house_prices_2019_training$nearest_station&lt;- factor(london_house_prices_2019_training$nearest_station,levels=c)
london_house_prices_2019_out_of_sample$nearest_station&lt;-factor(london_house_prices_2019_out_of_sample$nearest_station, levels=c)

d&lt;-union(levels(london_house_prices_2019_training$district),levels(london_house_prices_2019_out_of_sample$district))
london_house_prices_2019_training$district&lt;- factor(london_house_prices_2019_training$district,levels=d)
london_house_prices_2019_out_of_sample$district&lt;-factor(london_house_prices_2019_out_of_sample$district, levels=d)


#take a quick look at what&#39;s in the data
str(london_house_prices_2019_training)</code></pre>
<pre class="whitep"><code>## tibble [13,998 × 37] (S3: spec_tbl_df/tbl_df/tbl/data.frame)
##  $ ID                          : num [1:13998] 2 3 4 5 7 8 9 10 11 12 ...
##  $ date                        : Date[1:13998], format: &quot;2019-11-01&quot; &quot;2019-08-08&quot; ...
##  $ postcode                    : Factor w/ 12635 levels &quot;BR1 1AB&quot;,&quot;BR1 1LR&quot;,..: 10897 11027 11264 2031 11241 11066 421 9594 9444 873 ...
##  $ property_type               : Factor w/ 4 levels &quot;D&quot;,&quot;F&quot;,&quot;S&quot;,&quot;T&quot;: 2 2 3 2 3 2 1 4 4 2 ...
##  $ whether_old_or_new          : Factor w/ 2 levels &quot;N&quot;,&quot;Y&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ freehold_or_leasehold       : Factor w/ 2 levels &quot;F&quot;,&quot;L&quot;: 2 2 1 2 1 2 1 1 1 2 ...
##  $ address1                    : Factor w/ 2825 levels &quot;1&quot;,&quot;1 - 2&quot;,&quot;1 - 3&quot;,..: 2503 792 253 789 569 234 264 418 5 274 ...
##  $ address2                    : Factor w/ 434 levels &quot;1&quot;,&quot;10&quot;,&quot;101&quot;,..: 372 NA NA NA NA NA NA NA NA NA ...
##  $ address3                    : Factor w/ 8543 levels &quot;ABBERTON WALK&quot;,..: 6990 6821 3715 2492 4168 2879 3620 5251 6045 6892 ...
##  $ town                        : Factor w/ 133 levels &quot;ABBEY WOOD&quot;,&quot;ACTON&quot;,..: NA NA NA 78 NA NA NA NA NA NA ...
##  $ local_aut                   : Factor w/ 69 levels &quot;ASHFORD&quot;,&quot;BARKING&quot;,..: 36 46 24 36 24 46 65 36 36 17 ...
##  $ county                      : Factor w/ 33 levels &quot;BARKING AND DAGENHAM&quot;,..: 22 27 18 25 18 27 5 27 32 8 ...
##  $ postcode_short              : Factor w/ 248 levels &quot;BR1&quot;,&quot;BR2&quot;,&quot;BR3&quot;,..: 190 194 198 28 198 194 4 169 167 8 ...
##  $ current_energy_rating       : Factor w/ 6 levels &quot;B&quot;,&quot;C&quot;,&quot;D&quot;,&quot;E&quot;,..: 4 3 3 4 3 2 4 3 4 2 ...
##  $ total_floor_area            : num [1:13998] 30 50 100 39 88 101 136 148 186 65 ...
##  $ number_habitable_rooms      : num [1:13998] 2 2 5 2 4 4 6 6 6 3 ...
##  $ co2_emissions_current       : num [1:13998] 2.3 3 3.7 2.8 3.9 3.1 8.1 5.6 10 1.5 ...
##  $ co2_emissions_potential     : num [1:13998] 1.7 1.7 1.5 1.1 1.4 1.4 4.1 2 6.1 1.5 ...
##  $ energy_consumption_current  : num [1:13998] 463 313 212 374 251 175 339 216 308 128 ...
##  $ energy_consumption_potential: num [1:13998] 344 175 82 144 90 77 168 75 186 128 ...
##  $ windows_energy_eff          : Factor w/ 5 levels &quot;Average&quot;,&quot;Good&quot;,..: 1 1 1 5 1 1 1 1 5 1 ...
##  $ tenure                      : Factor w/ 3 levels &quot;owner-occupied&quot;,..: 1 2 1 2 1 1 1 2 1 1 ...
##  $ latitude                    : num [1:13998] 51.5 51.5 51.5 51.6 51.5 ...
##  $ longitude                   : num [1:13998] -0.1229 -0.2828 -0.4315 0.0423 -0.4293 ...
##  $ population                  : num [1:13998] 34 75 83 211 73 51 25 91 60 97 ...
##  $ altitude                    : num [1:13998] 8 9 25 11 21 11 95 7 7 106 ...
##  $ london_zone                 : num [1:13998] 1 3 5 3 6 6 3 2 2 3 ...
##  $ nearest_station             : Factor w/ 594 levels &quot;abbey road&quot;,&quot;abbey wood&quot;,..: 478 358 235 319 180 502 566 30 32 566 ...
##  $ water_company               : Factor w/ 5 levels &quot;Affinity Water&quot;,..: 5 5 1 5 1 5 5 5 5 5 ...
##  $ average_income              : num [1:13998] 57200 61900 50600 45400 49000 56200 57200 65600 50400 52300 ...
##  $ district                    : Factor w/ 33 levels &quot;Barking and Dagenham&quot;,..: 22 27 18 26 18 27 5 27 32 8 ...
##  $ price                       : num [1:13998] 360000 408500 499950 259999 395000 ...
##  $ type_of_closest_station     : Factor w/ 3 levels &quot;light_rail&quot;,&quot;rail&quot;,..: 3 2 3 1 3 2 1 3 1 1 ...
##  $ num_tube_lines              : num [1:13998] 1 0 1 0 1 0 0 2 0 0 ...
##  $ num_rail_lines              : num [1:13998] 0 1 1 0 1 1 0 0 1 0 ...
##  $ num_light_rail_lines        : num [1:13998] 0 0 0 1 0 0 1 0 1 1 ...
##  $ distance_to_station         : num [1:13998] 0.528 0.77 0.853 0.29 1.073 ...
##  - attr(*, &quot;spec&quot;)=
##   .. cols(
##   ..   ID = col_double(),
##   ..   date = col_date(format = &quot;&quot;),
##   ..   postcode = col_character(),
##   ..   property_type = col_character(),
##   ..   whether_old_or_new = col_character(),
##   ..   freehold_or_leasehold = col_character(),
##   ..   address1 = col_character(),
##   ..   address2 = col_character(),
##   ..   address3 = col_character(),
##   ..   town = col_character(),
##   ..   local_aut = col_character(),
##   ..   county = col_character(),
##   ..   postcode_short = col_character(),
##   ..   current_energy_rating = col_character(),
##   ..   total_floor_area = col_double(),
##   ..   number_habitable_rooms = col_double(),
##   ..   co2_emissions_current = col_double(),
##   ..   co2_emissions_potential = col_double(),
##   ..   energy_consumption_current = col_double(),
##   ..   energy_consumption_potential = col_double(),
##   ..   windows_energy_eff = col_character(),
##   ..   tenure = col_character(),
##   ..   latitude = col_double(),
##   ..   longitude = col_double(),
##   ..   population = col_double(),
##   ..   altitude = col_double(),
##   ..   london_zone = col_double(),
##   ..   nearest_station = col_character(),
##   ..   water_company = col_character(),
##   ..   average_income = col_double(),
##   ..   district = col_character(),
##   ..   price = col_double(),
##   ..   type_of_closest_station = col_character(),
##   ..   num_tube_lines = col_double(),
##   ..   num_rail_lines = col_double(),
##   ..   num_light_rail_lines = col_double(),
##   ..   distance_to_station = col_double()
##   .. )</code></pre>
<pre class="r pink"><code>str(london_house_prices_2019_out_of_sample)</code></pre>
<pre class="whitep"><code>## tibble [1,999 × 37] (S3: spec_tbl_df/tbl_df/tbl/data.frame)
##  $ ID                          : num [1:1999] 14434 12562 8866 10721 1057 ...
##  $ date                        : Date[1:1999], format: NA NA ...
##  $ postcode                    : logi [1:1999] NA NA NA NA NA NA ...
##  $ property_type               : Factor w/ 4 levels &quot;D&quot;,&quot;F&quot;,&quot;S&quot;,&quot;T&quot;: 1 2 2 3 4 3 2 3 2 4 ...
##  $ whether_old_or_new          : Factor w/ 2 levels &quot;N&quot;,&quot;Y&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ freehold_or_leasehold       : Factor w/ 2 levels &quot;F&quot;,&quot;L&quot;: 1 2 2 1 1 1 2 1 2 1 ...
##  $ address1                    : logi [1:1999] NA NA NA NA NA NA ...
##  $ address2                    : logi [1:1999] NA NA NA NA NA NA ...
##  $ address3                    : logi [1:1999] NA NA NA NA NA NA ...
##  $ town                        : Factor w/ 54 levels &quot;ACTON&quot;,&quot;ADDISCOMBE&quot;,..: NA NA NA NA NA NA NA NA NA NA ...
##  $ local_aut                   : logi [1:1999] NA NA NA NA NA NA ...
##  $ county                      : logi [1:1999] NA NA NA NA NA NA ...
##  $ postcode_short              : Factor w/ 248 levels &quot;BR1&quot;,&quot;BR2&quot;,&quot;BR3&quot;,..: 91 58 37 60 232 159 168 124 187 135 ...
##  $ current_energy_rating       : Factor w/ 6 levels &quot;B&quot;,&quot;C&quot;,&quot;D&quot;,&quot;E&quot;,..: 3 2 3 3 4 4 4 3 4 3 ...
##  $ total_floor_area            : num [1:1999] 150 59 58 74 97.3 ...
##  $ number_habitable_rooms      : num [1:1999] 6 2 2 5 5 5 5 4 2 5 ...
##  $ co2_emissions_current       : num [1:1999] 7.3 1.5 2.8 3.5 6.5 4.9 5.1 2.9 4.2 4.3 ...
##  $ co2_emissions_potential     : num [1:1999] 2.4 1.4 1.2 1.2 5.7 1.6 3 0.8 3.2 2.5 ...
##  $ energy_consumption_current  : num [1:1999] 274 142 253 256 303 309 240 224 458 253 ...
##  $ energy_consumption_potential: num [1:1999] 89 136 110 80 266 101 140 58 357 143 ...
##  $ windows_energy_eff          : Factor w/ 5 levels &quot;Average&quot;,&quot;Good&quot;,..: 1 1 1 1 1 1 3 1 3 1 ...
##  $ tenure                      : Factor w/ 3 levels &quot;owner-occupied&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ latitude                    : num [1:1999] 51.6 51.6 51.5 51.6 51.5 ...
##  $ longitude                   : num [1:1999] -0.129 -0.2966 -0.0328 -0.3744 -0.2576 ...
##  $ population                  : num [1:1999] 87 79 23 73 100 24 22 49 65 98 ...
##  $ altitude                    : num [1:1999] 63 38 17 39 8 46 26 16 14 18 ...
##  $ london_zone                 : num [1:1999] 4 4 2 5 2 4 3 6 1 3 ...
##  $ nearest_station             : Factor w/ 594 levels &quot;abbey road&quot;,&quot;abbey wood&quot;,..: 19 546 214 362 516 168 24 519 148 251 ...
##  $ water_company               : Factor w/ 5 levels &quot;Affinity Water&quot;,..: 5 1 5 1 5 5 5 2 5 5 ...
##  $ average_income              : num [1:1999] 61300 48900 46200 52200 60700 59600 64000 48100 56600 53500 ...
##  $ district                    : Factor w/ 33 levels &quot;Barking and Dagenham&quot;,..: 10 4 30 15 18 11 32 16 20 23 ...
##  $ type_of_closest_station     : Factor w/ 3 levels &quot;light_rail&quot;,&quot;rail&quot;,..: 3 3 1 2 3 2 3 3 3 2 ...
##  $ num_tube_lines              : num [1:1999] 1 2 0 0 2 0 1 1 2 0 ...
##  $ num_rail_lines              : num [1:1999] 0 1 0 1 0 1 1 0 0 1 ...
##  $ num_light_rail_lines        : num [1:1999] 0 1 1 0 0 0 0 1 0 0 ...
##  $ distance_to_station         : num [1:1999] 0.839 0.104 0.914 0.766 0.449 ...
##  $ asking_price                : num [1:1999] 750000 229000 152000 379000 930000 350000 688000 386000 534000 459000 ...
##  - attr(*, &quot;spec&quot;)=
##   .. cols(
##   ..   ID = col_double(),
##   ..   date = col_logical(),
##   ..   postcode = col_logical(),
##   ..   property_type = col_character(),
##   ..   whether_old_or_new = col_character(),
##   ..   freehold_or_leasehold = col_character(),
##   ..   address1 = col_logical(),
##   ..   address2 = col_logical(),
##   ..   address3 = col_logical(),
##   ..   town = col_character(),
##   ..   local_aut = col_logical(),
##   ..   county = col_logical(),
##   ..   postcode_short = col_character(),
##   ..   current_energy_rating = col_character(),
##   ..   total_floor_area = col_double(),
##   ..   number_habitable_rooms = col_double(),
##   ..   co2_emissions_current = col_double(),
##   ..   co2_emissions_potential = col_double(),
##   ..   energy_consumption_current = col_double(),
##   ..   energy_consumption_potential = col_double(),
##   ..   windows_energy_eff = col_character(),
##   ..   tenure = col_character(),
##   ..   latitude = col_double(),
##   ..   longitude = col_double(),
##   ..   population = col_double(),
##   ..   altitude = col_double(),
##   ..   london_zone = col_double(),
##   ..   nearest_station = col_character(),
##   ..   water_company = col_character(),
##   ..   average_income = col_double(),
##   ..   district = col_character(),
##   ..   type_of_closest_station = col_character(),
##   ..   num_tube_lines = col_double(),
##   ..   num_rail_lines = col_double(),
##   ..   num_light_rail_lines = col_double(),
##   ..   distance_to_station = col_double(),
##   ..   asking_price = col_double()
##   .. )</code></pre>
<pre class="r pink"><code>#describe(london_house_prices_2019_training)</code></pre>
<p>In my predictions, I will not use columns between date:country. For the rest of variables, I will investigate their performance and correlation to price in further steps.</p>
<pre class="r pink"><code>#let&#39;s do the initial split
set.seed(1)
train_test_split &lt;- initial_split(london_house_prices_2019_training, prop = 0.75) #training set contains 75% of the data
set.seed(1)
# Create the training dataset
train_data &lt;- training(train_test_split)
# Create the testing dataset
test_data &lt;- testing(train_test_split)</code></pre>
</div>
<div id="visualize-data" class="section level3">
<h3>Visualize data</h3>
<p>In this section I will visualise my data. The most useful plots will tackle factor variables from our dataset, as the numeric ones we can examine later on in the correlation matrix.</p>
<pre class="r pink"><code>#checking the data once again
#summary(train_data)
#glimpse(train_data)

# avg price in districts
train_data_vis1 &lt;- train_data %&gt;%
  group_by(district) %&gt;%
  summarise(avg = mean(price))


vis1 &lt;- train_data_vis1 %&gt;%
  ggplot (aes(y=avg, x=reorder(district,avg))) +
            geom_col() +
  coord_flip() +
  theme_bw() +
  theme(panel.grid.major.y = element_line(color = &quot;gray60&quot;, size = 0.1),
        panel.background = element_rect(fill = &quot;white&quot;, colour = &quot;white&quot;),
        axis.line = element_line(size = 1, colour = &quot;grey80&quot;),
        axis.ticks = element_line(size = 3,colour = &quot;grey80&quot;),
        plot.title = element_text(color = &quot;grey80&quot;,size=15,face=&quot;bold&quot;, family= &quot;Montserrat&quot;),
        axis.title.y = element_text(size = 8, angle = 90, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.y=element_text(family=&quot;Montserrat&quot;, size=7),
        axis.title.x = element_text(size = 8, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.x=element_text(family=&quot;Montserrat&quot;, size=7))+
    labs(y=&quot;Price&quot;, x=&quot;London district&quot;) 

vis1</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#avg price vs nearest station

train_data_vis2 &lt;- train_data %&gt;%
  group_by(nearest_station) %&gt;%
  summarise(avg = mean(price))

train_data_vis2&lt;-train_data_vis2 %&gt;% 
    arrange(desc(avg)) %&gt;% 
    filter(avg&gt;2000000)
 

vis2 &lt;- train_data_vis2 %&gt;%
  ggplot (aes(y=avg, x=reorder(nearest_station,avg))) +
            geom_col() +
  coord_flip() +
  theme_bw() +
  theme(panel.grid.major.y = element_line(color = &quot;gray60&quot;, size = 0.1),
        panel.background = element_rect(fill = &quot;white&quot;, colour = &quot;white&quot;),
        axis.line = element_line(size = 1, colour = &quot;grey80&quot;),
        axis.ticks = element_line(size = 3,colour = &quot;grey80&quot;),
        plot.title = element_text(color = &quot;grey80&quot;,size=15,face=&quot;bold&quot;, family= &quot;Montserrat&quot;),
        axis.title.y = element_text(size = 8, angle = 90, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.y=element_text(family=&quot;Montserrat&quot;, size=7),
        axis.title.x = element_text(size = 8, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.x=element_text(family=&quot;Montserrat&quot;, size=7))+
    labs(y=&quot;Price&quot;, x=&quot;Nearest station&quot;) 



vis2</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-2.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#Graph showing price in ths in particular property types  in regards to different london zones and station types

train_data_vis3 &lt;- train_data %&gt;%
  group_by(type_of_closest_station, property_type, london_zone) %&gt;%
  summarise(avg = mean(price))
  
train_data_vis3$property_type&lt;- train_data_vis3$property_type %&gt;% factor(levels=c(&quot;D&quot;,&quot;S&quot;, &quot;T&quot;, &quot;F&quot;))

vis3 &lt;- train_data_vis3 %&gt;%
  ggplot(aes(y=avg, x=property_type,fill=property_type))+
  geom_col() +
  facet_grid(type_of_closest_station~london_zone)+
  theme_bw() +
  theme(panel.grid.major.y = element_line(color = &quot;gray60&quot;, size = 0.1),
        strip.text= element_text(family=&quot;Montserrat&quot;, face = &quot;plain&quot;),
        panel.background = element_rect(fill = &quot;white&quot;, colour = &quot;white&quot;),
        axis.line = element_line(size = 1, colour = &quot;grey80&quot;),
        axis.ticks = element_line(size = 3,colour = &quot;grey80&quot;),
        axis.ticks.length = unit(.20, &quot;cm&quot;),
        plot.title = element_text(color = &quot;grey40&quot;,size=10,face=&quot;bold&quot;, family= &quot;Montserrat&quot;),
        plot.caption = element_text(color = &quot;grey40&quot;, face=&quot;italic&quot;,size= 7,family= &quot;Montserrat&quot;,hjust=0),
        axis.title.y = element_text(size = 8, angle = 90, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.y=element_text(family=&quot;Montserrat&quot;, size=7),
        axis.title.x = element_text(size = 8, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.x=element_text(family=&quot;Montserrat&quot;, size=7),
        legend.text=element_text(family=&quot;Montserrat&quot;, size=7),
        legend.title=element_text(family=&quot;Montserrat&quot;, size=8, face=&quot;bold&quot;)
                                  )+
    labs(title=&quot;Average price in regards to proerty types located in \nparticular london zones near specific types of stations&quot;,y=&quot;Price&quot;, x=&quot;Property type&quot;) +
  scale_fill_discrete(name = &quot;Property type&quot;, labels = c(&quot;Detached&quot;, &quot;Semi-detached&quot;, &quot;Terraced&quot;, &quot;Flat/Masionette&quot;))

vis3</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-3.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code># price vs distance to the station &amp; propety_type
train_data_vis4 &lt;- train_data %&gt;%
  group_by(property_type, distance_to_station) %&gt;%
  summarise(avg = mean(price))

vis4 &lt;- train_data_vis4 %&gt;%
  ggplot(aes(y=avg, x=distance_to_station))+
  geom_point()+
  facet_wrap(~property_type)


vis4</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-4.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code># energy_ratings vs price
train_data_vis5 &lt;- train_data %&gt;%
  group_by(current_energy_rating) %&gt;%
  summarise(avg = mean(price))

vis5 &lt;- train_data_vis5 %&gt;%
  ggplot(aes(y=avg, x=current_energy_rating))+
  geom_col()

vis5</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-5.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#correlations
vis6&lt;- train_data %&gt;% 
  select(distance_to_station, london_zone, price,) %&gt;% #order variables they will appear in ggpairs()
  ggpairs(aes(alpha = 0.3))+
  theme_bw()

vis6</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-6.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#price vs water_provider
train_data_vis7 &lt;- train_data %&gt;%
  group_by(water_company) %&gt;%
  summarise(avg = mean(price))


vis7 &lt;- train_data_vis7 %&gt;%
  ggplot (aes(y=avg, x=reorder(water_company,avg))) +
            geom_col() +
  coord_flip()

vis7</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-7.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#price vs freehold_or_leasehold
train_data_vis8 &lt;- train_data %&gt;%
  group_by(freehold_or_leasehold) %&gt;%
  summarise(avg = mean(price))


vis8 &lt;- train_data_vis8 %&gt;%
  ggplot (aes(y=avg, x=reorder(freehold_or_leasehold,avg))) +
            geom_col() +
  coord_flip()

vis8</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-8.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#price vs windows_energy_eff 
train_data_vis9 &lt;- train_data %&gt;%
  group_by(windows_energy_eff) %&gt;%
  summarise(avg = mean(price))


vis9 &lt;- train_data_vis9 %&gt;%
  ggplot (aes(y=avg, x=reorder(windows_energy_eff,avg))) +
            geom_col() +
  coord_flip()

vis9</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-9.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#price vs tenure  
train_data_vis10 &lt;- train_data %&gt;%
  group_by(tenure ) %&gt;%
  summarise(avg = mean(price))


vis10 &lt;- train_data_vis10 %&gt;%
  ggplot (aes(y=avg, x=reorder(tenure ,avg))) +
            geom_col() +
  coord_flip()

vis10</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-10.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#postcode_short
train_data_vis11 &lt;- train_data %&gt;%
  group_by(postcode_short) %&gt;%
  summarise(avg = mean(price)) %&gt;% 
  arrange(desc(avg)) %&gt;% 
  filter(avg&gt;2000000)


vis11&lt;- train_data_vis11 %&gt;%
  ggplot (aes(y=avg, x=reorder(postcode_short,avg))) +
            geom_col() +
  coord_flip()+
  theme_bw() +
  theme(panel.grid.major.y = element_line(color = &quot;gray60&quot;, size = 0.1),
        panel.background = element_rect(fill = &quot;white&quot;, colour = &quot;white&quot;),
        axis.line = element_line(size = 1, colour = &quot;grey80&quot;),
        axis.ticks = element_line(size = 3,colour = &quot;grey80&quot;),
        plot.title = element_text(color = &quot;grey80&quot;,size=15,face=&quot;bold&quot;, family= &quot;Montserrat&quot;),
        axis.title.y = element_text(size = 8, angle = 90, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.y=element_text(family=&quot;Montserrat&quot;, size=7),
        axis.title.x = element_text(size = 8, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.x=element_text(family=&quot;Montserrat&quot;, size=7))+
    labs(y=&quot;Price&quot;, x=&quot;Postcode short version&quot;) 

vis11</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-11.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>train_data_vis12 &lt;- train_data %&gt;%
  group_by(total_floor_area,london_zone) %&gt;%
  summarise(avg = mean(price)) %&gt;% 
  arrange(desc(avg))

vis12&lt;-train_data_vis12%&gt;%
  ggplot(aes(x=total_floor_area, y=avg))+
  geom_smooth() +
  facet_wrap(~london_zone)+
  theme_bw() +
  theme(panel.grid.major.y = element_line(color = &quot;gray60&quot;, size = 0.1),
        strip.text= element_text(family=&quot;Montserrat&quot;, face = &quot;plain&quot;),
        panel.background = element_rect(fill = &quot;white&quot;, colour = &quot;white&quot;),
        axis.line = element_line(size = 1, colour = &quot;grey80&quot;),
        axis.ticks = element_line(size = 3,colour = &quot;grey80&quot;),
        axis.ticks.length = unit(.20, &quot;cm&quot;),
        plot.title = element_text(color = &quot;grey40&quot;,size=10,face=&quot;bold&quot;, family= &quot;Montserrat&quot;),
        plot.caption = element_text(color = &quot;grey40&quot;, face=&quot;italic&quot;,size= 7,family= &quot;Montserrat&quot;,hjust=0),
        axis.title.y = element_text(size = 8, angle = 90, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.y=element_text(family=&quot;Montserrat&quot;, size=7),
        axis.title.x = element_text(size = 8, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.x=element_text(family=&quot;Montserrat&quot;, size=7),
        legend.text=element_text(family=&quot;Montserrat&quot;, size=7),
        legend.title=element_text(family=&quot;Montserrat&quot;, size=8, face=&quot;bold&quot;))+
    labs(title= &quot;Changes in average Price in regards to total floor area &amp; london_zone&quot;, y=&quot;Price&quot;, x=&quot;Total floor area in particular London zone&quot;) 
                   

vis12</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/visualize-12.png" width="648" style="display: block; margin: auto;" /></p>
<div id="learnings-from-visualisations" class="section level4">
<h4>Learnings from visualisations</h4>
It seems that the price of houses located in the most distinguished districts in London is significantly affected and much higher than in other districts - the same trend tackles the most popular and best located tube stations and postcodes_short.. Therefore, I will create three new varaibles in my data:
<ul>
<li>
<code>is_district</code> : that will have value “TRUE” for the most expensive districts and “FALSE” for the rest
</li>
<li>
<code>is_station</code> : that will take the value “TRUE” for the station where house price was above 2,000,000.
</li>
<li>
<code>is_postcode</code> : that will take the value “TRUE” for the postcode_short where house price exceeded 2,000,000.
</li>
</ul>
<p>Additionally, we can learn from the visualisations, that property_type and distance to the station combined also have a significant influence on the price. Also, london_zone and distance_to_station seem to be interconnected.</p>
<p>When in comes to such variables as “current_energy_rating”, “freehold_or_leasehold”, or“tenure”, we will need to deduct from the further models if any values are really significant for estimating the price or not.</p>
<p>From the graphs, we can deduct that for “water_company” and “windows_energy_eff” only one value of each variable seems to affect the price significantly. We will further exemine it in the next steps.</p>
</div>
</div>
<div id="feature-engineering" class="section level3">
<h3>Feature engineering</h3>
<p>I will now add new variables to my dayaset basing on what I found in the section above.</p>
<pre class="r pink"><code>#Adding variable &quot;is station&quot; for stations beloning to the one near which the price of a property sis significantly bigger (assumption: over 2,000,000)
train_data&lt;- train_data %&gt;% 
mutate(is_station = ifelse(nearest_station == &quot;hyde park corner&quot; | 
                             nearest_station == &quot;   knightsbridge&quot; |
                             nearest_station == &quot;south kensington&quot; |
                             nearest_station == &quot;   holland park&quot; |
                             nearest_station == &quot;bond street&quot;|
                             nearest_station == &quot;regents park&quot;|
                             nearest_station == &quot;high street kensington&quot;|
                             nearest_station == &quot;gloucester road&quot;|
                             nearest_station == &quot;sloane square&quot;, TRUE, FALSE ))

test_data&lt;- test_data %&gt;% 
mutate(is_station = ifelse(nearest_station == &quot;hyde park corner&quot; | 
                             nearest_station == &quot;   knightsbridge&quot; |
                             nearest_station == &quot;south kensington&quot; |
                             nearest_station == &quot;   holland park&quot; |
                             nearest_station == &quot;bond street&quot;|
                             nearest_station == &quot;regents park&quot;|
                             nearest_station == &quot;high street kensington&quot;|
                             nearest_station == &quot;gloucester road&quot;|
                             nearest_station == &quot;sloane square&quot;, TRUE, FALSE ))

london_house_prices_2019_out_of_sample&lt;- london_house_prices_2019_out_of_sample %&gt;% 
mutate(is_station = ifelse(nearest_station == &quot;hyde park corner&quot; | 
                             nearest_station == &quot;   knightsbridge&quot; |
                             nearest_station == &quot;south kensington&quot; |
                             nearest_station == &quot;   holland park&quot; |
                             nearest_station == &quot;bond street&quot;|
                             nearest_station == &quot;regents park&quot;|
                             nearest_station == &quot;high street kensington&quot;|
                             nearest_station == &quot;gloucester road&quot;|
                             nearest_station == &quot;sloane square&quot;, TRUE, FALSE ))


#Adding a variable is_district with 5 most expensive districts in London
train_data&lt;- train_data %&gt;% 
mutate(is_district = ifelse(district == &quot;Kensington and Chelsea&quot; |
                              district == &quot;Westminster&quot; |
                              district == &quot;Hammersmith and Fulham&quot; |
                              district == &quot;Camden&quot; |
                              district == &quot;Richmond upon Thames&quot;, TRUE, FALSE ))

test_data&lt;- test_data %&gt;% 
mutate(is_district = ifelse(district == &quot;Kensington and Chelsea&quot; |
                              district == &quot;Westminster&quot; |
                              district == &quot;Hammersmith and Fulham&quot; |
                              district == &quot;Camden&quot; |
                              district == &quot;Richmond upon Thames&quot;, TRUE, FALSE ))


london_house_prices_2019_out_of_sample&lt;- london_house_prices_2019_out_of_sample %&gt;% 
mutate(is_district = ifelse(district == &quot;Kensington and Chelsea&quot; |
                              district == &quot;Westminster&quot; |
                              district == &quot;Hammersmith and Fulham&quot; |
                              district == &quot;Camden&quot; |
                              district == &quot;Richmond upon Thames&quot;, TRUE, FALSE ))

#Adding a variable is_postcode with 6 most expensive postcodes in London
train_data&lt;- train_data %&gt;% 
mutate(is_postcode = ifelse(postcode_short == &quot;W1B&quot; | 
                             postcode_short == &quot;    SW1X&quot; |
                             postcode_short == &quot;W1K&quot; |
                             postcode_short == &quot;SW1W&quot; |
                             postcode_short == &quot;W8&quot;|
                             postcode_short == &quot;S3&quot;|
                              postcode_short == &quot;W11&quot;, TRUE, FALSE ))

test_data&lt;- test_data %&gt;% 
mutate(is_postcode = ifelse(postcode_short == &quot;W1B&quot; | 
                             postcode_short == &quot;    SW1X&quot; |
                             postcode_short == &quot;W1K&quot; |
                             postcode_short == &quot;SW1W&quot; |
                             postcode_short == &quot;W8&quot;|
                             postcode_short == &quot;S3&quot;|
                              postcode_short == &quot;W11&quot;, TRUE, FALSE ))

london_house_prices_2019_out_of_sample&lt;- london_house_prices_2019_out_of_sample %&gt;% 
mutate(is_postcode = ifelse(postcode_short == &quot;W1B&quot; | 
                             postcode_short == &quot;    SW1X&quot; |
                             postcode_short == &quot;W1K&quot; |
                             postcode_short == &quot;SW1W&quot; |
                             postcode_short == &quot;W8&quot;|
                             postcode_short == &quot;S3&quot;|
                              postcode_short == &quot;W11&quot;, TRUE, FALSE ))</code></pre>
</div>
<div id="distribution-of-dependent-variable" class="section level3">
<h3>Distribution of dependent variable</h3>
<p>I will now check the distirbution of the “price” variable to check if it follows the Normal distribution.</p>
<pre class="r pink"><code>#distribution of price 
train_data %&gt;% 
  ggplot(aes(x=price))+
  geom_histogram()+
  theme_bw() +
  theme(panel.grid.major.y = element_line(color = &quot;gray60&quot;, size = 0.1),
        panel.background = element_rect(fill = &quot;white&quot;, colour = &quot;white&quot;),
        axis.line = element_line(size = 1, colour = &quot;grey80&quot;),
        axis.ticks = element_line(size = 3,colour = &quot;grey80&quot;),
        plot.title = element_text(color = &quot;grey80&quot;,size=15,face=&quot;bold&quot;, family= &quot;Montserrat&quot;),
        axis.title.y = element_text(size = 8, angle = 90, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.y=element_text(family=&quot;Montserrat&quot;, size=7),
        axis.title.x = element_text(size = 8, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.x=element_text(family=&quot;Montserrat&quot;, size=7))+
    labs(x=&quot;Price&quot;, y=&quot;Count&quot;) </code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-3-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#distirbution of log price
train_data %&gt;% 
  ggplot(aes(x=log(price)))+
  geom_histogram()+
  theme_bw() +
  theme(panel.grid.major.y = element_line(color = &quot;gray60&quot;, size = 0.1),
        panel.background = element_rect(fill = &quot;white&quot;, colour = &quot;white&quot;),
        axis.line = element_line(size = 1, colour = &quot;grey80&quot;),
        axis.ticks = element_line(size = 3,colour = &quot;grey80&quot;),
        plot.title = element_text(color = &quot;grey80&quot;,size=15,face=&quot;bold&quot;, family= &quot;Montserrat&quot;),
        axis.title.y = element_text(size = 8, angle = 90, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.y=element_text(family=&quot;Montserrat&quot;, size=7),
        axis.title.x = element_text(size = 8, family=&quot;Montserrat&quot;, face = &quot;bold&quot;),
        axis.text.x=element_text(family=&quot;Montserrat&quot;, size=7))+
    labs(x=&quot;Log Price&quot;, y=&quot;Count&quot;)</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-3-2.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#train_data_log &lt;- train_data %&gt;% 
#  mutate(log_price=log(price))</code></pre>
<p>Price variable is highly right-skewed. For sake of this exercise I will not run the algorithm on the log price as the stack algorithm can use only one dependent variable. Tree based models that I will build in further steps can handle such a distribution much better and possibly will perform even better for price than for log(price). Therefore, to stay consistent, I will stick to “price” for all my models.</p>
</div>
<div id="numeric-variables" class="section level3">
<h3>Numeric variables</h3>
<p>I will now estimate a correlation table between prices and other continuous variables.</p>
<pre class="r pink"><code># produce a correlation table using GGally::ggcor()
# this takes a while to plot


#let&#39;s remember these are only correlations for numeric variables - the correlations for factor data can be also strongly related, what we could observe in the graphs before

train_data %&gt;% 
  select(-ID) %&gt;% #keep Y variable last
  ggcorr(method = c(&quot;pairwise&quot;, &quot;pearson&quot;), layout.exp = 2,label_round=2, label = TRUE,label_size = 2,hjust = 1,nbreaks = 5,size = 2,angle = -20)</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/correlation%20table-1.png" width="648" style="display: block; margin: auto;" />
Variables that are most correlated with “price” variable are: average_income, london_zone, co2_emissions_current, co2_emissions_potential, number_habitable_rooms and total_floor_area. Nevertheless, let’s keep in mind, that pairs: co2_emissions_current &amp; co2_emissions_potential and number_habitable_rooms &amp; total_floor_area are highly correlated. In my models i will as well investigate interactions of variables that have a reasonable explanation and are very weakly correlated.</p>
</div>
<div id="fit-a-linear-regression-model" class="section level3">
<h3>Fit a linear regression model</h3>
<p>First linear model comes from the workshop. I will build on it in future models.</p>
<div id="model-1" class="section level4">
<h4>Model 1</h4>
<pre class="r pink"><code># creating the control for all my future models - it needs to be the same for all of them in order to be able to stack them togehter in the end
CVfolds=15

indexProbs=createMultiFolds(train_data$price,times=1)
control &lt;- trainControl(method = &quot;cv&quot;, number = CVfolds, returnResamp = &quot;final&quot;, 
                     savePredictions = &quot;final&quot;,  # needs to be final or all
                     index = indexProbs, sampling=NULL)
#we are going to train the model and report the results using k-fold cross validation
#set.seed(1)
#model1_lm&lt;-train(
#    price ~ distance_to_station +water_company+property_type+whether_old_or_new+freehold_or_leasehold+latitude+ longitude,
#    train_data,
#   method = &quot;lm&quot;,
#    trControl = control
#   )

# summary of the results
#summary(model1_lm)</code></pre>
</div>
<div id="model-2" class="section level4">
<h4>Model 2</h4>
<pre class="r pink"><code>#we are going to train the model and report the results using k-fold cross validation
#set.seed(1)
#model2_lm&lt;-train(
#    price ~ total_floor_area+ number_habitable_rooms+ co2_emissions_current+co2_emissions_potential +average_income+ #longitude+num_tube_lines+num_rail_lines+distance_to_station,
#    train_data,
#  method = &quot;lm&quot;,
#    trControl = control
#   )

# summary of the results
#summary(model2_lm)</code></pre>
</div>
<div id="model-3" class="section level4">
<h4>Model 3</h4>
<pre class="r pink"><code>#we are going to train the model and report the results using k-fold cross validation
#set.seed(1)
#model3_lm&lt;-train(
#    price ~ total_floor_area+ number_habitable_rooms+ co2_emissions_potential +average_income+ longitude+num_tube_lines+property_type+current_energy_rating+windows_energy_eff +district+type_of_closest_station,
#    train_data,
#   method = &quot;lm&quot;,
#    trControl = control
#   )

# summary of the results
#summary(model3_lm)</code></pre>
</div>
<div id="model-4" class="section level4">
<h4>Model 4</h4>
<pre class="r pink"><code>#we are going to train the model and report the results using k-fold cross validation
#set.seed(1)
#model4_lm&lt;-train(
#    price ~ poly(total_floor_area,3)+sqrt(number_habitable_rooms)+number_habitable_rooms +average_income+ #longitude+num_tube_lines+windows_energy_eff +district+type_of_closest_station+ #property_type*type_of_closest_station+london_zone*distance_to_station+london_zone*property_type,
#    train_data,
#  method = &quot;lm&quot;,
#    trControl = control
#   )

# summary of the results
#summary(model4_lm)</code></pre>
</div>
<div id="model-5---final-model" class="section level4">
<h4>Model 5 - Final model</h4>
<p>In this model, I will add all the significant interactions that I found and the postcode_short variable.</p>
<pre class="r pink"><code>#we are going to train the model and report the results using k-fold cross validation
set.seed(1)
model5_lm&lt;-train(
    price ~ poly(total_floor_area,3)+number_habitable_rooms+sqrt(number_habitable_rooms)+average_income+current_energy_rating+windows_energy_eff+ property_type*type_of_closest_station+london_zone*distance_to_station+water_company+num_tube_lines+is_station+total_floor_area:london_zone+total_floor_area:num_tube_lines+average_income:number_habitable_rooms+postcode_short+district,
    train_data,
   method = &quot;lm&quot;,
    trControl = control)</code></pre>
<pre class="r pink"><code># summary of the results
# summary(model5_lm)

## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 213000 on 10216 degrees of freedom
## Multiple R-squared:  0.839,  Adjusted R-squared:  0.834 
## F-statistic:  188 on 282 and 10216 DF,  p-value: &lt;2e-16</code></pre>
<pre class="r pink"><code>performancelr&lt;- list()
performancelr[2]&lt;- model5_lm[[4]] %&gt;% 
  select(RMSE) %&gt;% 
  pull()

performancelr[1]&lt;- model5_lm[[4]] %&gt;% 
  select(Rsquared) %&gt;% 
  pull()

names(performancelr) &lt;- c(&quot;Rsquare&quot;, &quot;RMSE&quot;)
performancelr</code></pre>
<pre class="whitep"><code>## $Rsquare
## [1] 0.82
## 
## $RMSE
## [1] 222161</code></pre>
</div>
<div id="model-log" class="section level4">
<h4>Model log</h4>
<p>I will now try out how well the log_price performs vs. the unlogged one</p>
</div>
<div id="importance" class="section level4">
<h4>Importance</h4>
<pre class="r pink"><code># we can check variable importance as well
#importance1 &lt;- varImp(model1_lm, scale=TRUE)
#plot(importance1)

#importance2 &lt;- varImp(model2_lm, scale=TRUE)
#plot(importance2)

#importance3 &lt;- varImp(model3_lm, scale=TRUE)
#plot(importance3)

#importance4 &lt;- varImp(model4_lm, scale=TRUE)
#plot(importance4)

importance5&lt;- varImp(model5_lm, scale=TRUE)
plot(importance5)</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-11-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#importance5_log&lt;- varImp(model5_lm_log, scale=TRUE)
#plot(importance5_log)</code></pre>
</div>
<div id="predict-the-values-in-testing-and-out-of-sample-data" class="section level4">
<h4>Predict the values in testing and out of sample data</h4>
<p>Below I use the predict function to test the performance of the model in testing data and summarize the performance of the linear regression model. I can measure the quality of my predictions when looking at vlaues of RMSE and Rsquare. The lower the RMSE, the lower the error we can get in our predicted data. The higher the Rsquared, the more percentage of data is explained by the model.</p>
<pre class="r pink"><code># We can predict the testing values

#prediting the results on test_data 
set.seed(1)
predictions &lt;- predict(model5_lm,test_data)
summary(predictions)</code></pre>
<pre class="whitep"><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
## -186064  351066  463098  590293  653951 8552732</code></pre>
<pre class="r pink"><code>summary(train_data$price) # checking if the values are similar to the true ones</code></pre>
<pre class="whitep"><code>##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
##    77000   350000   460000   594480   655000 10500000</code></pre>
<pre class="r pink"><code>lr_results&lt;-data.frame(  RMSE = RMSE(predictions, test_data$price), 
                            Rsquare = R2(predictions, test_data$price))
lr_results </code></pre>
<pre class="whitep"><code>##     RMSE Rsquare
## 1 202699   0.842</code></pre>
<pre class="r pink"><code>#We can predict prices for out of sample data the same way
#predictions_oos &lt;- predict(model5_lm,london_house_prices_2019_out_of_sample)
#predictions_oos</code></pre>
</div>
</div>
<div id="tree-model" class="section level3">
<h3>Tree model</h3>
<p>Next I fit a tree model using the same subset of features. Again I will add more variables in the next steps and tune the parameter of my tree to find a better fit.</p>
<div id="first-model" class="section level4">
<h4>First model</h4>
<pre class="r pink"><code>#model2_tree &lt;- train(
#  price ~ distance_to_station +water_company+property_type+whether_old_or_new+freehold_or_leasehold+latitude+ longitude,
#  train_data,
#  method = &quot;rpart&quot;,
#  trControl = control,
#  tuneLength=2
#    )

#You can view how the tree performs
#model2_tree$results

#You can view the final tree
#rpart.plot(model2_tree$finalModel)

#you can also visualize the variable importance
#importance &lt;- varImp(model2_tree, scale=TRUE)
#plot(importance)</code></pre>
</div>
<div id="model-tree-2" class="section level4">
<h4>Model tree 2</h4>
<pre class="r pink"><code>#model3_tree &lt;- train(
#  price ~ total_floor_area +average_income+ longitude+num_tube_lines #+property_type+london_zone+distance_to_station+latitude+is_station+number_habitable_rooms+current_energy_rating+windows_energy_eff+ #is_district,
#  train_data,
#  method = &quot;rpart&quot;,
#  trControl = control,
#  tuneLength=15
# )


#You can view how the tree performs
#model3_tree$results

#You can view the final tree
#rpart.plot(model3_tree$finalModel)

#you can also visualize the variable importance
#importance &lt;- varImp(model3_tree, scale=TRUE)
#plot(importance)
#importance</code></pre>
</div>
<div id="tree-model-4" class="section level4">
<h4>Tree model 4</h4>
<pre class="r pink"><code>#set.seed(1)
#model4_tree &lt;- train(
#  price ~ total_floor_area +average_income+ longitude+latitude+
#    num_tube_lines +
#    property_type+london_zone+distance_to_station+is_station+is_district+current_energy_rating+type_of_closest_station,
#  train_data,
#  method = &quot;rpart&quot;,
#  trControl = control,
#  tuneLength=15
#    )

#You can view how the tree performs
#model4_tree$results

#You can view the final tree
#rpart.plot(model4_tree$finalModel)

#you can also visualize the variable importance
#importance &lt;- varImp(model4_tree, scale=TRUE)
#plot(importance)

#varImp(model4_tree)</code></pre>
</div>
<div id="next-tree-model" class="section level4">
<h4>Next tree model</h4>
<pre class="r pink"><code>#setting seed
set.seed(1)
#prediction for next model
modeltrial2 &lt;- train(
  price ~ total_floor_area +average_income+ longitude+latitude+current_energy_rating+num_tube_lines +type_of_closest_station+property_type+london_zone+distance_to_station+is_station+is_district+is_postcode,
  train_data, 
  method = &quot;rpart&quot;,
  metric=&quot;Rsquared&quot;,
 trControl = control,
  tuneLength=15)

# performance of the tree
modeltrial2$results</code></pre>
<pre class="whitep"><code>##         cp   RMSE Rsquared    MAE RMSESD RsquaredSD MAESD
## 1  0.00678 280228    0.711 158448  28626     0.0613  4687
## 2  0.00857 286345    0.697 163129  33236     0.0657  4141
## 3  0.00891 288773    0.692 165861  33296     0.0671  5390
## 4  0.00904 289539    0.690 166786  32845     0.0660  5116
## 5  0.00988 290066    0.689 167704  33655     0.0680  6222
## 6  0.01043 291305    0.686 169564  32881     0.0691  6875
## 7  0.01117 295575    0.677 172553  32559     0.0659  6828
## 8  0.01330 299305    0.668 174214  33552     0.0758  7039
## 9  0.01519 307410    0.650 178251  36428     0.0774  5840
## 10 0.03224 322109    0.620 181936  40114     0.0658  7637
## 11 0.03852 332548    0.598 184410  47044     0.0799  9421
## 12 0.04310 346772    0.558 194132  41461     0.0729  9683
## 13 0.07590 369473    0.495 214703  42384     0.0995 15876
## 14 0.16197 424347    0.343 235566  57846     0.0698 10491
## 15 0.31416 470699    0.294 257490  50547     0.0316 22986</code></pre>
<pre class="r pink"><code># view the final tree
rpart.plot(modeltrial2$finalModel)</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-16-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code># you can also visualize the variable importance
#importance &lt;- varImp(modeltrial2, scale=TRUE)
#plot(importance)

#varImp(modeltrial2)</code></pre>
</div>
<div id="choosing-the-right-split-for-model-tree-4" class="section level4">
<h4>Choosing the right split for model tree 4</h4>
<pre class="r pink"><code>#modelLookup(&quot;rpart&quot;)

#I choose cp values that seems to result in low error based on plot above
Grid &lt;- expand.grid(cp = seq( 0.000, 0.00085,0.00005))


#choosing seed
set.seed(1)
#training model
modeltrial2 &lt;- train(
  price ~ total_floor_area +average_income+ longitude+latitude+current_energy_rating+num_tube_lines +type_of_closest_station+property_type+london_zone+distance_to_station+postcode_short+district+energy_consumption_current+is_station+is_district+is_postcode,
  train_data, 
  method = &quot;rpart&quot;,
  metric=&quot;Rsquared&quot;,
  trControl = control,
  tuneGrid=Grid)


#performance of the model
print(modeltrial2)</code></pre>
<pre class="whitep"><code>## CART 
## 
## 10499 samples
##    16 predictor
## 
## No pre-processing
## Resampling: Cross-Validated (15 fold) 
## Summary of sample sizes: 9449, 9450, 9449, 9449, 9448, 9450, ... 
## Resampling results across tuning parameters:
## 
##   cp       RMSE    Rsquared  MAE   
##   0.00000  238948  0.792     116769
##   0.00005  238798  0.792     116161
##   0.00010  239072  0.791     117372
##   0.00015  240248  0.789     119481
##   0.00020  240670  0.788     120771
##   0.00025  241638  0.786     121826
##   0.00030  241753  0.786     122536
##   0.00035  242028  0.785     123863
##   0.00040  243232  0.783     124706
##   0.00045  244243  0.781     125638
##   0.00050  245215  0.779     126421
##   0.00055  245621  0.779     127182
##   0.00060  245995  0.778     127453
##   0.00065  246394  0.777     128082
##   0.00070  246982  0.776     128714
##   0.00075  247834  0.774     129626
##   0.00080  248632  0.773     130377
##   0.00085  249088  0.772     131070
## 
## Rsquared was used to select the optimal model using the largest value.
## The final value used for the model was cp = 0.</code></pre>
<pre class="r pink"><code>#plot of the cp values
plot(modeltrial2)</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-17-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#plotting the tree
rpart.plot(modeltrial2$finalModel)</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-17-2.png" width="648" style="display: block; margin: auto;" /></p>
</div>
<div id="final-tree-model" class="section level4">
<h4>Final tree model</h4>
<pre class="r pink"><code>#choosing small grid so the algorithm choose the best local cp
Grid &lt;- expand.grid(cp = seq( 0.00005, 0.00015,0.00005))

#setting seed
set.seed(1)
#training model
model_tree_final &lt;- train(
  price ~ total_floor_area +average_income+ longitude+latitude+current_energy_rating+num_tube_lines +type_of_closest_station+property_type+london_zone+distance_to_station+postcode_short+district+energy_consumption_current+is_station+is_district+is_postcode,
  train_data, 
  method = &quot;rpart&quot;,
  metric=&quot;Rsquared&quot;,
  trControl = control,
  tuneGrid=Grid)

#plotting cp
plot(model_tree_final)</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-18-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#plotting tree
rpart.plot(model_tree_final$finalModel)</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-18-2.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#Predict the probabilities using the tree model in testing data
predictions_tree &lt;- predict(model_tree_final,test_data)

tree_results&lt;-data.frame(  RMSE = RMSE(predictions_tree, test_data$price), 
                            Rsquare = R2(predictions_tree, test_data$price))
tree_results </code></pre>
<pre class="whitep"><code>##     RMSE Rsquare
## 1 242413   0.777</code></pre>
<pre class="r pink"><code>#RMSE &amp; Rsquare of final tree model
performancetree&lt;- list() #creating list
performancetree[2]&lt;- model_tree_final[[4]] %&gt;% 
  filter(cp == model_tree_final$bestTune$cp) %&gt;% #adding RMSE
  select(RMSE) %&gt;% 
  pull()

performancetree[1]&lt;- model_tree_final[[4]] %&gt;% 
  filter(cp == model_tree_final$bestTune$cp) %&gt;% #adding Rsquare
  select(Rsquared) %&gt;% 
  pull()

names(performancetree) &lt;- c(&quot;Rsquare&quot;, &quot;RMSE&quot;) #rename
performancetree</code></pre>
<pre class="whitep"><code>## $Rsquare
## [1] 0.792
## 
## $RMSE
## [1] 238798</code></pre>
<p>As expected a single tree in this case does not perform this well, however it is expected. This is why in my further analysis I will use hundreds of trees. One single tree overfits easily and is not the best predictor.</p>
</div>
</div>
<div id="other-algorithms" class="section level3">
<h3>Other algorithms</h3>
<p>I will use three other algorithms to predict prices. I will also tune the parameters of these algorithms in order to obtain best possible performance.</p>
<div id="lasso-model" class="section level4">
<h4>LASSO model</h4>
<pre class="r pink"><code>#  LASSO model

#we will look for the optimal lambda in this sequence
lambda_seq &lt;- seq(0, 5000, length = 1000)


#LASSO regression with using 5-fold cross validation to select the best lambda amonst the lambdas specified in &quot;lambda_seq&quot;.
#setting seed
set.seed(1)
#training lasso model
lasso &lt;- train(
 price~ whether_old_or_new+freehold_or_leasehold+latitude+ longitude+ poly(total_floor_area,3)+average_income+current_energy_rating+windows_energy_eff +district+ property_type*type_of_closest_station+london_zone*distance_to_station+water_company+is_station+number_habitable_rooms+sqrt(number_habitable_rooms)+ num_tube_lines+total_floor_area:london_zone+total_floor_area:num_tube_lines+average_income:number_habitable_rooms+co2_emissions_current+co2_emissions_potential+postcode_short+is_district+is_postcode,
 data = train_data,
 method = &quot;glmnet&quot;,
  preProc = c(&quot;center&quot;, &quot;scale&quot;), #This option standardizes the data before running the LASSO regression
  trControl = control,
  tuneGrid = expand.grid(alpha = 1, lambda = lambda_seq) #alpha=1 specifies to run a LASSO regression. If alpha=0 the model would run ridge regression.
  )
#plotting lamba values
plot(lasso)</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-19-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#coef(lasso$finalModel, lasso$bestTune$lambda) #best lambda

#RMSE &amp; Rsquare of the model
performancelasso&lt;- list() #creating a list
performancelasso[2]&lt;- lasso[[4]] %&gt;%  #adding RMSE
  filter(lambda == lasso$bestTune$lambda) %&gt;% 
  select(RMSE) %&gt;% 
  pull()

performancelasso[1]&lt;- lasso[[4]] %&gt;%  #adding Rsquare
  filter(lambda == lasso$bestTune$lambda) %&gt;% 
  select(Rsquared) %&gt;% 
  pull()

names(performancelasso) &lt;- c(&quot;Rsquare&quot;, &quot;RMSE&quot;) #rename
performancelasso</code></pre>
<pre class="whitep"><code>## $Rsquare
## [1] 0.823
## 
## $RMSE
## [1] 219953</code></pre>
<pre class="r pink"><code>#prediction on test_data
predictions_lasso &lt;- predict(lasso,test_data)


# Model prediction performance
LASSO_results&lt;-data.frame(  RMSE = RMSE(predictions_lasso, test_data$price), 
                            Rsquare = R2(predictions_lasso, test_data$price))
LASSO_results </code></pre>
<pre class="whitep"><code>##     RMSE Rsquare
## 1 201073   0.844</code></pre>
<p>As we can see, the best performance is for lambda=0, which translates for linear regression with no regularization. Therefore, in my multimodel, I will choose only one of these.</p>
</div>
<div id="random-forest" class="section level4">
<h4>RANDOM FOREST</h4>
<p>Parameters for random forest models in the ranger function that implements random forest i) ‘mtry’: number of randomly chosen variables to do a split each time ii) splitrule: purity measure we use. I will only use gini iii) min.node.size: Minimum size allowed for a leaf iv) ‘importance’: is an option to get a sense of the importance of the variables. We will use it below.</p>
<pre class="r pink"><code>modelLookup(&quot;ranger&quot;)</code></pre>
<pre class="whitep"><code>##    model     parameter                         label forReg forClass probModel
## 1 ranger          mtry #Randomly Selected Predictors   TRUE     TRUE      TRUE
## 2 ranger     splitrule                Splitting Rule   TRUE     TRUE      TRUE
## 3 ranger min.node.size             Minimal Node Size   TRUE     TRUE      TRUE</code></pre>
<pre class="r pink"><code># Define the tuning grid: tuneGrid
Gridtune= data.frame(mtry=c(10:15),
                     min.node.size = 5,
                     splitrule=&quot;variance&quot;)



# we will now train random forest model
#set seed
set.seed(1)
#train model
rfregFit &lt;- train(price~poly(total_floor_area,2) +average_income+ longitude+latitude+current_energy_rating+num_tube_lines +type_of_closest_station+property_type+london_zone+distance_to_station+is_station+is_district +water_company+freehold_or_leasehold+is_postcode , 
               data = train_data, 
               method = &quot;ranger&quot;,
               trControl=control,
               # calculate importance
               importance=&quot;permutation&quot;, 
               tuneGrid = Gridtune,
               num.trees = 200)

#importance of variables
varImp(rfregFit)</code></pre>
<pre class="whitep"><code>## ranger variable importance
## 
##   only 20 most important variables shown (out of 26)
## 
##                                    Overall
## poly(total_floor_area, 2)1         100.000
## poly(total_floor_area, 2)2          31.097
## london_zone                         26.664
## is_districtTRUE                     22.242
## longitude                           15.167
## average_income                       8.483
## is_stationTRUE                       8.187
## freehold_or_leaseholdL               8.179
## latitude                             7.732
## property_typeF                       6.489
## is_postcodeTRUE                      3.408
## num_tube_lines                       2.732
## distance_to_station                  2.241
## property_typeT                       2.129
## water_companyThames Water            1.340
## type_of_closest_stationtube          1.034
## property_typeS                       0.934
## type_of_closest_stationrail          0.733
## water_companyEssex &amp; Suffolk Water   0.441
## current_energy_ratingC               0.400</code></pre>
<pre class="r pink"><code>#plot of important variables
plot(varImp(rfregFit))</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-20-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#summary of grid tuning &amp; RMSE &amp;Rsquare
print(rfregFit)</code></pre>
<pre class="whitep"><code>## Random Forest 
## 
## 10499 samples
##    15 predictor
## 
## No pre-processing
## Resampling: Cross-Validated (15 fold) 
## Summary of sample sizes: 9449, 9450, 9449, 9449, 9448, 9450, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE    Rsquared  MAE  
##   10    193471  0.863     93978
##   11    194828  0.861     94385
##   12    194761  0.861     94560
##   13    194908  0.861     94448
##   14    194910  0.861     94717
##   15    195655  0.860     95110
## 
## Tuning parameter &#39;splitrule&#39; was held constant at a value of variance
## 
## Tuning parameter &#39;min.node.size&#39; was held constant at a value of 5
## RMSE was used to select the optimal model using the smallest value.
## The final values used for the model were mtry = 10, splitrule = variance
##  and min.node.size = 5.</code></pre>
<pre class="r pink"><code>#predictions for data_test
predictions_rf &lt;-predict(rfregFit,test_data)

# Model prediction performance
rf_results&lt;-data.frame(  RMSE = RMSE(predictions_rf, test_data$price), 
                            Rsquare = R2(predictions_rf, test_data$price))
rf_results </code></pre>
<pre class="whitep"><code>##     RMSE Rsquare
## 1 191418    0.86</code></pre>
</div>
<div id="gradient-boosting-machine" class="section level4">
<h4>GRADIENT BOOSTING MACHINE</h4>
<pre class="r pink"><code>modelLookup(&quot;gbm&quot;)</code></pre>
<pre class="whitep"><code>##   model         parameter                   label forReg forClass probModel
## 1   gbm           n.trees   # Boosting Iterations   TRUE     TRUE      TRUE
## 2   gbm interaction.depth          Max Tree Depth   TRUE     TRUE      TRUE
## 3   gbm         shrinkage               Shrinkage   TRUE     TRUE      TRUE
## 4   gbm    n.minobsinnode Min. Terminal Node Size   TRUE     TRUE      TRUE</code></pre>
<pre class="r pink"><code>#Expand the search grid (see above for definitions)
grid&lt;-expand.grid(interaction.depth = 8,n.trees = 500,shrinkage =0.05, n.minobsinnode = 5)
#Train for gbm
#set seed
set.seed(1)
#train model
gbmFit1 &lt;- train(price~poly(total_floor_area,3) +average_income+ longitude+latitude+current_energy_rating+num_tube_lines +property_type+london_zone*distance_to_station+is_station+is_district +water_company+freehold_or_leasehold+is_postcode+total_floor_area:london_zone+property_type:type_of_closest_station+district, 
               data = train_data,
                 method = &quot;gbm&quot;, 
                 trControl = control,
                 tuneGrid =grid,
                   metric = &quot;RMSE&quot;,
                 verbose = FALSE
                 )


#RMSE &amp; Rsquare
print(gbmFit1)</code></pre>
<pre class="whitep"><code>## Stochastic Gradient Boosting 
## 
## 10499 samples
##    16 predictor
## 
## No pre-processing
## Resampling: Cross-Validated (15 fold) 
## Summary of sample sizes: 9449, 9450, 9449, 9449, 9448, 9450, ... 
## Resampling results:
## 
##   RMSE    Rsquared  MAE  
##   197973  0.856     97070
## 
## Tuning parameter &#39;n.trees&#39; was held constant at a value of 500
## Tuning
## 
## Tuning parameter &#39;shrinkage&#39; was held constant at a value of 0.05
## 
## Tuning parameter &#39;n.minobsinnode&#39; was held constant at a value of 5</code></pre>
<pre class="r pink"><code>#variables importance
varImp(gbmFit1)</code></pre>
<pre class="whitep"><code>## gbm variable importance
## 
##   only 20 most important variables shown (out of 67)
## 
##                                 Overall
## poly(total_floor_area, 3)1      100.000
## london_zone                      29.678
## is_districtTRUE                  16.556
## poly(total_floor_area, 3)2       11.677
## longitude                         9.069
## districtKensington and Chelsea    8.390
## average_income                    7.772
## is_stationTRUE                    6.949
## london_zone:total_floor_area      5.772
## is_postcodeTRUE                   4.916
## latitude                          4.431
## poly(total_floor_area, 3)3        4.335
## london_zone:distance_to_station   2.795
## distance_to_station               2.380
## districtWestminster               1.383
## num_tube_lines                    1.352
## property_typeF                    0.998
## freehold_or_leaseholdL            0.870
## current_energy_ratingD            0.489
## property_typeT                    0.344</code></pre>
<pre class="r pink"><code>#plot on variables importance
plot(varImp(gbmFit1))</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-21-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>#performance of predicted values on test_data
predictions_GBM &lt;-predict(gbmFit1, test_data)

GBM_results&lt;-data.frame(  RMSE = RMSE(predictions_GBM, test_data$price), 
                            Rsquare = R2(predictions_GBM, test_data$price))
GBM_results </code></pre>
<pre class="whitep"><code>##     RMSE Rsquare
## 1 186632   0.866</code></pre>
</div>
</div>
<div id="all-models-performance-compared" class="section level3">
<h3>All models’ performance compared</h3>
<p>Now I will compare performance of all my models. To do so, I will compare the Rsquare (not the Adjusted one!) of all the models.</p>
<pre class="r pink"><code>performancelr</code></pre>
<pre class="whitep"><code>## $Rsquare
## [1] 0.82
## 
## $RMSE
## [1] 222161</code></pre>
<pre class="r pink"><code>performancetree</code></pre>
<pre class="whitep"><code>## $Rsquare
## [1] 0.792
## 
## $RMSE
## [1] 238798</code></pre>
<pre class="r pink"><code>performancelasso </code></pre>
<pre class="whitep"><code>## $Rsquare
## [1] 0.823
## 
## $RMSE
## [1] 219953</code></pre>
<pre class="r pink"><code> print(rfregFit)</code></pre>
<pre class="whitep"><code>## Random Forest 
## 
## 10499 samples
##    15 predictor
## 
## No pre-processing
## Resampling: Cross-Validated (15 fold) 
## Summary of sample sizes: 9449, 9450, 9449, 9449, 9448, 9450, ... 
## Resampling results across tuning parameters:
## 
##   mtry  RMSE    Rsquared  MAE  
##   10    193471  0.863     93978
##   11    194828  0.861     94385
##   12    194761  0.861     94560
##   13    194908  0.861     94448
##   14    194910  0.861     94717
##   15    195655  0.860     95110
## 
## Tuning parameter &#39;splitrule&#39; was held constant at a value of variance
## 
## Tuning parameter &#39;min.node.size&#39; was held constant at a value of 5
## RMSE was used to select the optimal model using the smallest value.
## The final values used for the model were mtry = 10, splitrule = variance
##  and min.node.size = 5.</code></pre>
<pre class="r pink"><code>print(gbmFit1)</code></pre>
<pre class="whitep"><code>## Stochastic Gradient Boosting 
## 
## 10499 samples
##    16 predictor
## 
## No pre-processing
## Resampling: Cross-Validated (15 fold) 
## Summary of sample sizes: 9449, 9450, 9449, 9449, 9448, 9450, ... 
## Resampling results:
## 
##   RMSE    Rsquared  MAE  
##   197973  0.856     97070
## 
## Tuning parameter &#39;n.trees&#39; was held constant at a value of 500
## Tuning
## 
## Tuning parameter &#39;shrinkage&#39; was held constant at a value of 0.05
## 
## Tuning parameter &#39;n.minobsinnode&#39; was held constant at a value of 5</code></pre>
<p>We can compare linear regression &amp; LASSO model - they both perform quite similarly due to the complexity of linear regression.
On the other hand, when we run the tree model, a single tree performs always much worse than more complex models - Random Forest and Gradient Boosting Machine.
Nevertheless, in the stacking model, it is good to stack numerous models as they are able to catch different kinds of results. E.g. linear regression is able to catch much better the linear trends.</p>
</div>
<div id="stacking" class="section level3">
<h3>Stacking</h3>
<p>I will now use stacking to ensemble 4 of my created algorithms.</p>
<pre class="r pink"><code>multimodel&lt;- list(tree=model_tree_final,lasso=lasso,ranger= rfregFit, gbm= gbmFit1)
class(multimodel)&lt;- &quot;caretList&quot;</code></pre>
<div id="visualising-results" class="section level4">
<h4>Visualising results</h4>
<pre class="r pink"><code>modelCor(resamples(multimodel)) #correlation matrix of the models</code></pre>
<pre class="whitep"><code>##         tree lasso ranger   gbm
## tree   1.000 0.860  0.912 0.890
## lasso  0.860 1.000  0.916 0.866
## ranger 0.912 0.916  1.000 0.941
## gbm    0.890 0.866  0.941 1.000</code></pre>
<pre class="r pink"><code>dotplot(resamples(multimodel), metric=&quot;Rsquared&quot;) #Rsquare comparison</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-24-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>xyplot(resamples(multimodel), metric=&quot;Rsquared&quot;) #tree vs lasso</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-24-2.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r pink"><code>splom(resamples(multimodel), metric=&quot;Rsquared&quot;) #all the models&#39; performance interactions</code></pre>
<p><img src="/portfolio/project-10_files/figure-html/unnamed-chunk-24-3.png" width="648" style="display: block; margin: auto;" /></p>
</div>
<div id="creation-of-the-stack-model" class="section level4">
<h4>Creation of the stack model</h4>
<pre class="r pink"><code>library(caret)
library(caretEnsemble)
model_list&lt;- caretStack(multimodel, #creating a model that stacks both models together
                        trControl=control,
                        method=&quot;lm&quot;,
                        metric=&quot;RMSE&quot;)

#summary of the model
summary(model_list)</code></pre>
<pre class="whitep"><code>## 
## Call:
## lm(formula = .outcome ~ ., data = dat)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -4032689   -49841     1715    50655  4049428 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -2.30e+04   3.08e+03   -7.46  9.2e-14 ***
## tree         3.35e-03   1.32e-02    0.25      0.8    
## lasso        2.10e-01   1.36e-02   15.45  &lt; 2e-16 ***
## ranger       5.79e-01   2.79e-02   20.74  &lt; 2e-16 ***
## gbm          2.45e-01   2.46e-02    9.92  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 192000 on 10494 degrees of freedom
## Multiple R-squared:  0.865,  Adjusted R-squared:  0.865 
## F-statistic: 1.68e+04 on 4 and 10494 DF,  p-value: &lt;2e-16</code></pre>
<pre class="r pink"><code># RMSE &amp; Rsquaere
performancefinal&lt;- list() #creating a list
performancefinal[2]&lt;- model_list[[3]] %&gt;% #adding RMSE
  select(RMSE) %&gt;% 
  pull()

performancefinal[1]&lt;- model_list[[3]] %&gt;% #adding Rsquare
  select(Rsquared) %&gt;% 
  pull()

names(performancefinal) &lt;- c(&quot;Rsquare&quot;, &quot;RMSE&quot;) #rename
performancefinal #check the values</code></pre>
<pre class="whitep"><code>## $Rsquare
## [1] 0.868
## 
## $RMSE
## [1] 189661</code></pre>
<p>As we can see, the Rsuqared achieves the best results in comparison to our all previous models. the RMSE is equal to 189661.2 and the Rsquare equals 86.8%. Therefore, we will use this model as an estimation engine to guide the investment on the housing market in London.</p>
</div>
</div>
<div id="performance-on-test-data" class="section level3">
<h3>Performance on test data</h3>
<p>First I will check the preformance of our model on the test dataset.</p>
<pre class="r pink"><code>numchoose=200 #choosing number of investments
set.seed(1) #set seed
random_mult&lt;-1/(1-runif(nrow(test_data),min=-0.2, max=0.2))
test_data$asking_price&lt;-test_data$price*random_mult #creating the asking_price simulation

#Assume that these are asking prices

#now predict the value of houses
test_data$predict&lt;-predict(model_list,test_data)

#choose the ones that you want to invest here

#Let’s find the profit margin given our predicted price and asking price

test_data&lt;-test_data %&gt;% 
  mutate(profitMargin=(predict-asking_price)/(asking_price)) %&gt;% 
  arrange(-profitMargin)
#Make sure you chooses exactly 200 of them
test_data$invest=0
test_data[1:numchoose,]$invest=1

#let&#39;s find the actual profit
test_data&lt;-test_data %&gt;% 
  mutate(profit=(price-asking_price)/(asking_price), actualProfit=invest*profit)

mean(test_data$profit)</code></pre>
<pre class="whitep"><code>## [1] 0.0019</code></pre>
<pre class="r pink"><code>sum(test_data$actualProfit)/numchoose</code></pre>
<pre class="whitep"><code>## [1] 0.0678</code></pre>
<p>The silumation gives us positice results with the average profit on all the investments amouting to 0.19% and the average profit from 200 best investments equal o 6%.</p>
</div>
<div id="picking-investment-portfolio" class="section level3">
<h3>Picking investment portfolio</h3>
<p>In this section I will use the best algorithm I identified to choose 200 properties from the out of sample data. I will report 20 first raws of my original dataset with the scores.</p>
<pre class="r pink"><code>numchoose=200 # choosing number of properties we will invest in

oos&lt;-london_house_prices_2019_out_of_sample
#predict the value of houses
oos$predict&lt;-predict(model_list,oos)
#Choose the ones you want to invest here
#Make sure you choose exactly 200 of them

oos&lt;-oos %&gt;% 
  mutate(profitMargin=(predict-asking_price)/(asking_price)) %&gt;% 
  arrange(-profitMargin)
#Make sure you chooses exactly 200 of them
oos$buy=0
oos[1:numchoose,]$buy=1
oos&lt;-oos %&gt;% mutate( actualProfit=buy*profitMargin)
#let&#39;s find the actual profit
mean(oos$profitMargin)</code></pre>
<pre class="whitep"><code>## [1] 0.0387</code></pre>
<pre class="r pink"><code>sum(oos$actualProfit)/numchoose</code></pre>
<pre class="whitep"><code>## [1] 0.685</code></pre>
<p>Final perdictions lead us to the following results. The average profit margin of all the properties in the data set equals 3.86%, whereas the average profit from 200 best investments equals 68.45%. Our engine works. I will provide the documentation of all the steps taken and explanantion of all the models in my technial report.</p>
<p>Thank you.</p>
</div>

          </div>
          <div class="site-project-single-image">
            
          </div>
          
          <div class="site-project-single-action">
            <a href="/portfolio/project-09/">
              <span class="link-area">
                <span data-text="Next Project">
                  Next Project
                </span>
              </span>
              <img src="/images/to-top.svg" alt="next project">
            </a>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</section>


  
  <section class="site-cta" style='background-image: url("/images/backgrounds/cta-background.jpg");'>
    <div class="container">
      <div class="row">
        <div class="col-12 text-center">
          <h1 class="site-cta-title">Contact me</h1>
          <ul class="site-cta-buttons">
            <li>
              <a href="/contact" class="btn btn-secondary">
                <span class="btn-area">
                  <span data-text="Send an email">
                    Send an email
                  </span>
                </span>
              </a>
            </li>
            <li>
              <a href="/portfolio" class="btn btn-primary">
                <span class="btn-area">
                  <span data-text="See more portfolio">
                    See more portfolio
                  </span>
                </span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>
  



        </main><footer class="site-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="site-footer-logo"><a href="/"><img src="/images/logo-footer.png" alt="logo-footer"></a></div>
      </div>
      
      <div class="col-lg-3 col-md-6">
        <div class="site-footer-widget">
          <h5 class="site-footer-widget-title">Contact Info</h5>
          <p class="site-footer-widget-description">
            Regent's Park, London NW1 4SA
            <br>
            <a href="tel:&#43;447762727403">&#43;447762727403</a>
            <br>
            <a href="mailto:aprawda.mam2021@london.edu">aprawda.mam2021@london.edu</a>
          </p>
        </div>
      </div>
      
      
      
      <div class="col-lg-2 col-md-6">
        <div class="site-footer-widget">
          <h5 class="site-footer-widget-title">Social Media</h5>
          <ul class="site-footer-widget-links">
            
              <li><a href="https://www.linkedin.com/in/agnieszka-prawda/">Linkedin</a></li>
            
          </ul>
        </div>
      </div>
      
      
      <div class="col-lg-2 col-12">
        <a href="#top" class="site-footer-widget-top">
          <img src="/images/to-top.svg" alt="back-to-top">
          <p>
            I want to 
            <br>
            visit again
          </p>
        </a>
      </div>
    </div>
  </div>
</footer>


<script src="/js/formhandler.min.js"></script>

<script src="/js/vendor.min.js"></script>

<script src="/js/script.min.js"></script></body>
</html>
